{
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "minutes"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        -816,
        64
      ],
      "id": "d90e41aa-2405-4942-ba4d-a176aa13df85",
      "name": "Schedule Trigger - A cada 5 minutos"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Query para Resgate de Conversas - Grupo √Åurea\n-- Busca conversas onde Th√©o foi o √∫ltimo a responder e cliente n√£o retornou\n-- ATUALIZADO: Intervalos de 15 minutos e 2 horas\n-- CORRIGIDO: Padr√µes ILIKE ajustados para ignorar formata√ß√£o markdown (*Sim* vs Sim)\n\nWITH\n-- √öltima mensagem NORMAL do Th√©o (exclui mensagens de resgate)\nultima_msg_normal AS (\n  SELECT DISTINCT ON (m.conversation_id)\n    m.conversation_id,\n    m.created_at as ultima_msg_at,\n    m.content\n  FROM messages m\n  WHERE m.message_type = 1\n    AND m.sender_type = 'User'\n    AND m.sender_id = 16\n    AND NOT (\n      m.content ILIKE '%alto volume de atendimentos di√°rios%'\n      OR m.content ILIKE '%gostaria de seguir com o processo%'\n    )\n  ORDER BY m.conversation_id, m.created_at DESC\n),\n\n-- √öltima mensagem de RESGATE 1 (15 min)\nultima_msg_resgate1 AS (\n  SELECT DISTINCT ON (m.conversation_id)\n    m.conversation_id,\n    m.created_at as ultima_msg_at\n  FROM messages m\n  WHERE m.message_type = 1\n    AND m.sender_type = 'User'\n    AND m.sender_id = 16\n    AND m.content ILIKE '%alto volume de atendimentos di√°rios%'\n  ORDER BY m.conversation_id, m.created_at DESC\n),\n\n-- Conversas eleg√≠veis para RESGATE 15 MINUTOS\nconversas_15min AS (\n  SELECT\n    c.id as conversation_id,\n    c.account_id,\n    c.inbox_id,\n    c.contact_id,\n    c.display_id,\n    c.assignee_id,\n    ct.phone_number as contact_phone,\n    um.ultima_msg_at as ultima_msg_theo_at,\n    um.content as ultima_msg_content,\n    EXTRACT(EPOCH FROM (NOW() - um.ultima_msg_at))/60 as minutos_desde_ultima_msg,\n    '15_minutos' as categoria_tempo\n  FROM conversations c\n  INNER JOIN ultima_msg_normal um ON c.id = um.conversation_id\n  LEFT JOIN contacts ct ON c.contact_id = ct.id\n  WHERE c.status = 0\n    AND c.assignee_id IS NULL\n    AND c.team_id IS NULL\n    AND EXTRACT(EPOCH FROM (NOW() - um.ultima_msg_at))/60 BETWEEN 14 AND 20\n    -- Verifica se N√ÉO existe mensagem de resgate 1 j√° enviada\n    AND NOT EXISTS (\n      SELECT 1 FROM messages m\n      WHERE m.conversation_id = c.id\n        AND m.message_type = 1\n        AND m.created_at > um.ultima_msg_at\n        AND m.content ILIKE '%alto volume de atendimentos di√°rios%'\n    )\n    -- Verifica se cliente N√ÉO respondeu ap√≥s √∫ltima msg do Th√©o\n    AND NOT EXISTS (\n      SELECT 1 FROM messages m\n      WHERE m.conversation_id = c.id\n        AND m.message_type = 0\n        AND m.created_at > um.ultima_msg_at\n    )\n),\n\n-- Conversas eleg√≠veis para RESGATE 2 HORAS\nconversas_2h AS (\n  SELECT\n    c.id as conversation_id,\n    c.account_id,\n    c.inbox_id,\n    c.contact_id,\n    c.display_id,\n    c.assignee_id,\n    ct.phone_number as contact_phone,\n    um.ultima_msg_at as ultima_msg_theo_at,\n    NULL as ultima_msg_content,\n    EXTRACT(EPOCH FROM (NOW() - um.ultima_msg_at))/60 as minutos_desde_ultima_msg,\n    '2_horas' as categoria_tempo\n  FROM conversations c\n  INNER JOIN ultima_msg_resgate1 um ON c.id = um.conversation_id\n  LEFT JOIN contacts ct ON c.contact_id = ct.id\n  WHERE c.status = 0\n    AND c.assignee_id IS NULL\n    AND c.team_id IS NULL\n    AND EXTRACT(EPOCH FROM (NOW() - um.ultima_msg_at))/60 BETWEEN 115 AND 130\n    -- Verifica se N√ÉO existe mensagem de resgate 2 j√° enviada\n    AND NOT EXISTS (\n      SELECT 1 FROM messages m\n      WHERE m.conversation_id = c.id\n        AND m.message_type = 1\n        AND m.created_at > um.ultima_msg_at\n        AND m.content ILIKE '%gostaria de seguir com o processo%'\n    )\n    -- Verifica se cliente N√ÉO respondeu ap√≥s msg de resgate 1\n    AND NOT EXISTS (\n      SELECT 1 FROM messages m\n      WHERE m.conversation_id = c.id\n        AND m.message_type = 0\n        AND m.created_at > um.ultima_msg_at\n    )\n)\n\nSELECT * FROM conversas_15min\nUNION ALL\nSELECT * FROM conversas_2h\nORDER BY minutos_desde_ultima_msg ASC\nLIMIT 50\n",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -592,
        64
      ],
      "id": "173b7ddd-6883-4fbd-98eb-622290de0c1d",
      "name": "Buscar Conversas Pausadas",
      "credentials": {
        "postgres": {
          "id": "IT0NoFEDEFya6oUV",
          "name": "Cordex.ai - Chatwoot"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -368,
        64
      ],
      "id": "b6b291fe-c5c3-43a4-b54f-b77070047e22",
      "name": "Loop Conversas"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "d960d499-6da2-4997-9747-b4cb310982c6",
                    "leftValue": "={{ $json.categoria_tempo }}",
                    "rightValue": "15_minutos",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "15 minutos"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.categoria_tempo }}",
                    "rightValue": "2_horas",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "877f3d17-3a10-4c2c-93cd-696535eaf37d"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "2 horas"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        -80,
        -32
      ],
      "id": "1a8dca23-0e05-4c4e-8394-49ef8c2e3195",
      "name": "Switch por Tempo"
    },
    {
      "parameters": {
        "url": "https://github.com/pmcholding/AureaAgent/raw/refs/heads/main/audio_repescagem.mp3",
        "options": {
          "response": {
            "response": {
              "responseFormat": "file"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        160,
        -120
      ],
      "id": "c3d4e5f6-7890-12cd-ef01-333333333333",
      "name": "Baixar √Åudio Repescagem"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://app.doutorai.com.br/api/v1/accounts/{{ $('Switch por Tempo').item.json.account_id }}/conversations/{{ $('Switch por Tempo').item.json.display_id }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "contentType": "multipart-form-data",
        "bodyParameters": {
          "parameters": [
            {
              "name": "message_type",
              "value": "outgoing"
            },
            {
              "name": "private",
              "value": "false"
            },
            {
              "parameterType": "formBinaryData",
              "name": "attachments[]",
              "inputDataFieldName": "data"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        360,
        -120
      ],
      "id": "a1b2c3d4-5678-90ab-cdef-111111111111",
      "name": "Enviar √Åudio Repescagem",
      "credentials": {
        "httpHeaderAuth": {
          "id": "tr56s7v9Vbai5IBE",
          "name": "Chatwoot - Theo Aurea"
        }
      }
    },
    {
      "parameters": {
        "amount": 2,
        "unit": "seconds"
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        560,
        -120
      ],
      "id": "b2c3d4e5-6789-01bc-def0-222222222222",
      "name": "Aguardar 2s",
      "webhookId": "resgate-wait-audio"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://app.doutorai.com.br/api/v1/accounts/{{ $('Switch por Tempo').item.json.account_id }}/conversations/{{ $('Switch por Tempo').item.json.display_id }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "content",
              "value": "Estamos com um alto volume de atendimentos di√°rios e quero garantir que voc√™ conhe√ßa nosso *cr√©dito sem taxas ou antecipa√ß√µes*, com o primeiro pagamento *s√≥ em 15 dias*. Posso te transferir para um especialista humano agora para voc√™ contratar! üíô\n\nPor favor, responda:\n*Sim* ‚Üí para prosseguir com um especialista\n*N√£o* ‚Üí para encerrar o atendimento"
            },
            {
              "name": "message_type",
              "value": "outgoing"
            },
            {
              "name": "private",
              "value": false
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        760,
        -120
      ],
      "id": "42263931-2f45-4fa2-a0a0-4c60adc9ca21",
      "name": "Mensagem 15 Minutos",
      "credentials": {
        "httpHeaderAuth": {
          "id": "tr56s7v9Vbai5IBE",
          "name": "Chatwoot - Theo Aurea"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://app.doutorai.com.br/api/v1/accounts/{{ $json.account_id }}/conversations/{{ $json.display_id }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "content",
              "value": "Voc√™ gostaria de seguir com o processo, ou prefere que eu encerre o atendimento por agora?\n\nPor favor, responda:\n*Seguir* ‚Üí para continuar com um especialista\n*Encerrar* ‚Üí para finalizar o atendimento"
            },
            {
              "name": "message_type",
              "value": "outgoing"
            },
            {
              "name": "private",
              "value": false
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        160,
        160
      ],
      "id": "52f8ef57-9917-4211-a8c6-651baa45323d",
      "name": "Mensagem 2 Horas",
      "credentials": {
        "httpHeaderAuth": {
          "id": "tr56s7v9Vbai5IBE",
          "name": "Chatwoot - Theo Aurea"
        }
      }
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_chat_histories_aurea",
          "mode": "list",
          "cachedResultName": "n8n_chat_histories_aurea"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "session_id": "={{ $('Buscar Conversas Pausadas').item.json.contact_phone }}",
            "message": "={\"type\": \"ai\", \"content\": \"[√Åudio de repescagem enviado] Estamos com um alto volume de atendimentos di√°rios e quero garantir que voc√™ conhe√ßa nosso cr√©dito sem taxas ou antecipa√ß√µes, com o primeiro pagamento s√≥ em 15 dias. Posso te transferir para um especialista humano agora para voc√™ contratar! Por favor, responda: Sim ‚Üí para prosseguir com um especialista N√£o ‚Üí para encerrar o atendimento\", \"additional_kwargs\": {}, \"response_metadata\": {}}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "message",
              "displayName": "message",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "object",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        400,
        -32
      ],
      "id": "002e0d84-fbf3-4d12-a5ff-47a2defb03ee",
      "name": "Salvar Historico IA - 15min",
      "credentials": {
        "postgres": {
          "id": "IT0NoFEDEFya6oUV",
          "name": "Cordex.ai - Chatwoot"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_chat_histories_aurea",
          "mode": "list",
          "cachedResultName": "n8n_chat_histories_aurea"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "session_id": "={{ $('Buscar Conversas Pausadas').item.json.contact_phone }}",
            "message": "={\"type\": \"ai\", \"content\": \"Voc√™ gostaria de seguir com o processo, ou prefere que eu encerre o atendimento por agora? Por favor, responda: Seguir ‚Üí para continuar com um especialista Encerrar ‚Üí para finalizar o atendimento\", \"additional_kwargs\": {}, \"response_metadata\": {}}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "message",
              "displayName": "message",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "object",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        400,
        160
      ],
      "id": "1bdaef24-b89a-4940-9d4c-f6e2c80d871a",
      "name": "Salvar Historico IA - 2h",
      "credentials": {
        "postgres": {
          "id": "IT0NoFEDEFya6oUV",
          "name": "Cordex.ai - Chatwoot"
        }
      },
      "onError": "continueRegularOutput"
    }
  ],
  "connections": {
    "Schedule Trigger - A cada 5 minutos": {
      "main": [
        [
          {
            "node": "Buscar Conversas Pausadas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Conversas Pausadas": {
      "main": [
        [
          {
            "node": "Loop Conversas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Conversas": {
      "main": [
        [],
        [
          {
            "node": "Switch por Tempo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch por Tempo": {
      "main": [
        [
          {
            "node": "Baixar √Åudio Repescagem",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Mensagem 2 Horas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Baixar √Åudio Repescagem": {
      "main": [
        [
          {
            "node": "Enviar √Åudio Repescagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar √Åudio Repescagem": {
      "main": [
        [
          {
            "node": "Aguardar 2s",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aguardar 2s": {
      "main": [
        [
          {
            "node": "Mensagem 15 Minutos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mensagem 15 Minutos": {
      "main": [
        [
          {
            "node": "Salvar Historico IA - 15min",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mensagem 2 Horas": {
      "main": [
        [
          {
            "node": "Salvar Historico IA - 2h",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Salvar Historico IA - 15min": {
      "main": [
        [
          {
            "node": "Loop Conversas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Salvar Historico IA - 2h": {
      "main": [
        [
          {
            "node": "Loop Conversas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "meta": {
    "instanceId": "0dff2809c326d67264ac89b11c62a81c0e33c81a110b2979fd152608e157400d"
  }
}